@model HomeBrowseTracksViewModel

@{
    ViewBag.Title = Model.PageTitle;
}

<main class="public-main">
    <section class="page-header header-hero public-hero">
        <div class="header-glow-bg"></div>
        <div class="page-header-container">
            <div class="header-content fade-in">
                <div class="page-badge">
                    <i class="fas fa-route"></i> Start Your Journey
                </div>

                <h1 class="page-title">
                    Master Your Skills<br />
                    with <span class="text-gradient">Learning Tracks</span>
                </h1>

                <p class="page-subtitle">
                    Follow structured paths with
                    <span class="highlight-code">@Model.TotalCount+</span>
                    curated learning tracks. From beginner to expert.
                </p>
            </div>

            <div class="header-visuals slide-in">
                <div class="hero-stat-card float-slow">
                    <div class="hero-icon icon-box-purple">
                        <i class="fas fa-route"></i>
                    </div>
                    <div class="hero-stat-info">
                        <span class="hero-number">Track</span>
                        <span class="hero-label">Guided Paths</span>
                    </div>
                </div>

                <div class="hero-stat-card float-fast">
                    <div class="hero-icon icon-box-cyan">
                        <i class="fas fa-book"></i>
                    </div>
                    <div class="hero-stat-info">
                        <span class="hero-number">Multi</span>
                        <span class="hero-label">Courses</span>
                    </div>
                </div>

                <div class="hero-stat-card float-medium">
                    <div class="hero-icon icon-box-orange">
                        <i class="fas fa-trophy"></i>
                    </div>
                    <div class="hero-stat-info">
                        <span class="hero-number">Cert</span>
                        <span class="hero-label">Certified</span>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="explore-container">
        <div class="results-area" style="max-width: 100%;">
            <div class="results-toolbar">
                <div class="toolbar-left">
                    <div class="view-toggle-group">
                        <button class="view-btn active" id="gridViewBtn" title="Grid View">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button class="view-btn" id="listViewBtn" title="List View">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>

                <div class="toolbar-right" style="display: flex; gap: 1rem; align-items: center;">
                    <div class="filter-dropdown" id="sortByContainer">
                        <button class="filter-dropdown-btn" style="min-width: 180px">
                            <i class="fas fa-sort"></i>
                            <span id="sortByDisplay">Popularity</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>

                        <div class="filter-dropdown-menu">
                            <button class="filter-option" data-value="title">A-Z</button>
                            <button class="filter-option active" data-value="popularity">Popularity</button>
                            <button class="filter-option" data-value="rating">Rating</button>
                            <button class="filter-option" data-value="duration">Duration</button>
                        </div>

                        <input type="hidden" id="sortFilter" value="popularity" />
                    </div>

                    <div class="filter-dropdown" id="sortOrderContainer">
                        <button class="filter-dropdown-btn" style="min-width: 150px">
                            <i class="fas fa-arrow-down-wide-short"></i>
                            <span id="sortOrderDisplay">Descending</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>

                        <div class="filter-dropdown-menu">
                            <button class="filter-option" data-value="asc">Ascending</button>
                            <button class="filter-option active" data-value="desc">Descending</button>
                        </div>

                        <input type="hidden" id="sortOrder" value="desc" />
                    </div>
                </div>
            </div>

            <div class="results-info">
                <p class="results-count">
                    Showing <strong id="resultsCount">@Model.Tracks.Count</strong> of <strong>@Model.TotalCount</strong> learning tracks
                </p>
            </div>

            <div class="courses-catalog" id="tracksCatalog">
                @await Html.PartialAsync("_TracksGridBrowsePartialView", Model.Tracks)
            </div>

            <!-- Pagination Section -->
            <div class="pagination-container" id="paginationContainer">
                @await Html.PartialAsync("_PaginationPartialView", Model.PaginationSettings)
            </div>
        </div>
    </div>
</main>

@section Styles {
    <link rel="stylesheet" href="~/css/pages/Home/browse-courses.css" />
    <link rel="stylesheet" href="~/css/pagination.css" />
    <style>
        .results-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .results-area {
            width: 100%;
        }
        
        .explore-container {
            padding: 2rem;
            max-width: 1600px;
            margin: 0 auto;
        }
        
        @@media (max-width: 768px) {
            .results-toolbar {
                flex-direction: column;
                align-items: stretch;
            }
            
            .toolbar-left, .toolbar-right {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
}

@section Scripts {
    <script>
        // Browse Tracks Page - Pagination and Sorting
        (function() {
            'use strict';
            
            // State
            let currentPage = @Model.PaginationSettings.CurrentPage;
            let pageSize = @Model.PaginationSettings.PageSize;
            let sortBy = 'popularity';
            let sortOrder = 'desc';
            
            // Initialize
            document.addEventListener('DOMContentLoaded', function() {
                initViewToggle();
                initSortDropdowns();
            });
            
            // View Toggle (Grid/List)
            function initViewToggle() {
                const gridBtn = document.getElementById('gridViewBtn');
                const listBtn = document.getElementById('listViewBtn');
                const catalog = document.getElementById('tracksCatalog');
                
                if (gridBtn) {
                    gridBtn.addEventListener('click', function() {
                        gridBtn.classList.add('active');
                        listBtn?.classList.remove('active');
                        catalog?.classList.remove('list-view');
                        localStorage.setItem('tracksViewMode', 'grid');
                    });
                }
                
                if (listBtn) {
                    listBtn.addEventListener('click', function() {
                        listBtn.classList.add('active');
                        gridBtn?.classList.remove('active');
                        catalog?.classList.add('list-view');
                        localStorage.setItem('tracksViewMode', 'list');
                    });
                }
                
                // Restore saved view
                const savedView = localStorage.getItem('tracksViewMode');
                if (savedView === 'list') {
                    listBtn?.click();
                }
            }
            
            // Sort Dropdowns
            function initSortDropdowns() {
                // Sort By dropdown
                const sortByContainer = document.getElementById('sortByContainer');
                const sortByBtn = sortByContainer?.querySelector('.filter-dropdown-btn');
                const sortByOptions = sortByContainer?.querySelectorAll('.filter-option');
                const sortByDisplay = document.getElementById('sortByDisplay');
                const sortByInput = document.getElementById('sortFilter');
                
                if (sortByBtn) {
                    sortByBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        sortByContainer.classList.toggle('active');
                        document.getElementById('sortOrderContainer')?.classList.remove('active');
                    });
                }
                
                sortByOptions?.forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.textContent.trim();
                        
                        sortByOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        if (sortByDisplay) sortByDisplay.textContent = text;
                        if (sortByInput) sortByInput.value = value;
                        
                        sortBy = value;
                        sortByContainer.classList.remove('active');
                        
                        currentPage = 1;
                        loadTracks();
                    });
                });
                
                // Sort Order dropdown
                const sortOrderContainer = document.getElementById('sortOrderContainer');
                const sortOrderBtn = sortOrderContainer?.querySelector('.filter-dropdown-btn');
                const sortOrderOptions = sortOrderContainer?.querySelectorAll('.filter-option');
                const sortOrderDisplay = document.getElementById('sortOrderDisplay');
                const sortOrderInput = document.getElementById('sortOrder');
                
                if (sortOrderBtn) {
                    sortOrderBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        sortOrderContainer.classList.toggle('active');
                        document.getElementById('sortByContainer')?.classList.remove('active');
                    });
                }
                
                sortOrderOptions?.forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.dataset.value;
                        const text = this.textContent.trim();
                        
                        sortOrderOptions.forEach(opt => opt.classList.remove('active'));
                        this.classList.add('active');
                        
                        if (sortOrderDisplay) sortOrderDisplay.textContent = text;
                        if (sortOrderInput) sortOrderInput.value = value;
                        
                        sortOrder = value;
                        sortOrderContainer.classList.remove('active');
                        
                        currentPage = 1;
                        loadTracks();
                    });
                });
                
                // Close dropdowns when clicking outside
                document.addEventListener('click', function() {
                    sortByContainer?.classList.remove('active');
                    sortOrderContainer?.classList.remove('active');
                });
            }
            
            // Load Tracks via AJAX
            function loadTracks() {
                const catalog = document.getElementById('tracksCatalog');
                const pagination = document.getElementById('paginationContainer');
                const resultsCount = document.getElementById('resultsCount');
                
                // Show loading state
                if (catalog) {
                    catalog.style.opacity = '0.5';
                    catalog.style.pointerEvents = 'none';
                }
                
                const requestData = {
                    currentPage: currentPage,
                    pageSize: pageSize,
                    sortBy: sortBy,
                    sortOrder: sortOrder
                };
                
                fetch('/filter-tracks', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                })
                .then(response => response.json())
                .then(data => {
                    if (catalog) {
                        catalog.innerHTML = data.TracksGrid;
                        catalog.style.opacity = '1';
                        catalog.style.pointerEvents = 'auto';
                        
                        // Restore view mode
                        const savedView = localStorage.getItem('tracksViewMode');
                        if (savedView === 'list') {
                            catalog.classList.add('list-view');
                        }
                    }
                    
                    if (pagination) {
                        pagination.innerHTML = data.Pagination;
                    }
                    
                    if (resultsCount) {
                        resultsCount.textContent = Math.min(currentPage * pageSize, data.TotalCount);
                    }
                    
                    // Scroll to top of results
                    document.querySelector('.results-area')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })
                .catch(error => {
                    console.error('Error loading tracks:', error);
                    if (catalog) {
                        catalog.style.opacity = '1';
                        catalog.style.pointerEvents = 'auto';
                    }
                });
            }
            
            // Global function for pagination buttons
            window.fetchPage = function(button, offset) {
                if (button.classList.contains('disabled')) return;
                
                let targetPage;
                
                if (offset === -1) {
                    // Previous
                    targetPage = currentPage - 1;
                } else if (offset === 1) {
                    // Next
                    targetPage = currentPage + 1;
                } else {
                    // Direct page number
                    targetPage = parseInt(button.textContent.trim());
                }
                
                if (targetPage && targetPage !== currentPage && targetPage >= 1) {
                    currentPage = targetPage;
                    loadTracks();
                }
            };
        })();
    </script>
}